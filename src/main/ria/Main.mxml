<?xml version="1.0" ?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:nestor="nestor.component.*"
                creationComplete="initApp(event)">

    <mx:Metadata>
        [ResourceBundle("resources")]
    </mx:Metadata>

    <mx:Script><![CDATA[
        import mx.collections.ArrayCollection;
        import mx.core.IFlexDisplayObject;
        import mx.events.FlexEvent;
        import mx.events.ValidationResultEvent;
        import mx.managers.PopUpManager;
        import mx.managers.PopUpManagerChildList;
        import mx.resources.ResourceManager;
        import mx.rpc.events.ResultEvent;

        import nestor.component.*;
        import nestor.model.*;


        [Bindable]
        public function getString(key:String):String {
            return resourceManager.getString("resources", key);
        }


        [Bindable]
        public var program:Program = new Program();

        [Bindable]
        public var recipients:ArrayCollection;

        [Bindable]
        public var bureaus:ArrayCollection;

        private function initApp(event:FlexEvent):void {
            trace(resourceManager.getLocales())
            pickerService.listAllBureaus();
            pickerService.listAllRecipients();
        }

        private function initRecipients(event:ResultEvent):void
        {
            recipients = event.result as ArrayCollection;
            //trace(recipients[0].id);
        }

        private function initBureaus(event:ResultEvent):void
        {
            bureaus = event.result as ArrayCollection;
        }


        private function search():void {
            srv.findByName(searchText.text);
        }

        private function save():void {
            var validationResult:Array = Validator.validateAll([nameValidator, recipientValidator]);
            if (validationResult.length > 0) return;

            // Hopefully this will be gone in Flex 4 ...
            program.name = programName.text;
            program.managerName = managerName.text;
            program.recipient = Recipient(recipient.selectedItem)
            program.bureau = Bureau(bureau.selectedItem)
            program.bureauDesignationDate = bureauDesignationDate.selectedDate;
            program.councilDate = councilDate.selectedDate;
            program.managerDesignationDate = managerDesignationDate.selectedDate;
            srv.save(program);
        }

        private function createResult(event:ResultEvent):void
        {
            program = event.result as Program;
            var _creationDate:String = program.creationDate != null ? program.creationDate.toLocaleTimeString() : null;
            var _modifiedDate:String = program.modifiedDate != null ? program.modifiedDate.toLocaleTimeString() : null;
            if (_creationDate != null) {
                creationDate.text = " Créé le " + _creationDate;
            }
            ;
            if (_modifiedDate != null) {
                modificationDate.text = " Sauvegarder le " + _modifiedDate;
            }
            ;
        }

        private function showBureauPicker(evt:MouseEvent):void {
            var popup = PopUpManager.createPopUp(this, BureauPicker, true);
            calcPopUpPos(popup, evt);
        }

        private function showRecipientPicker(evt:MouseEvent):void {
            var popup = PopUpManager.createPopUp(this, RecipientPicker, true, PopUpManagerChildList.POPUP);
            calcPopUpPos(popup, evt);
        }

        private function calcPopUpPos(popup:IFlexDisplayObject, evt:MouseEvent) {
            var point:Point = new Point();
            point.x = evt.localX;
            point.y = evt.localY;
            point = evt.target.localToGlobal(point);
            popup.x = point.x;
            popup.y = point.y;
        }

        ]]>
    </mx:Script>

    <mx:RemoteObject id="srv" destination="program">
        <mx:method name="save" result="createResult(event)"/>
        <mx:method name="findByName" result="createResult(event)"/>
    </mx:RemoteObject>

    <mx:RemoteObject id="pickerService" destination="picker">
        <mx:method name="listAllRecipients" result="initRecipients(event)"/>
        <mx:method name="listAllBureaus" result="initBureaus(event)"/>
    </mx:RemoteObject>

    <mx:Validator id="nameValidator" source="{programName}" property="text" required="true"/>
    <mx:Validator id="recipientValidator" source="{recipient}" property="selectedItem" required="true"/>


    <mx:HBox horizontalAlign="right" width="100%">
        <mx:TextInput id="searchText" width="100"/>
        <mx:Button label="{resourceManager.getString('resources', 'search')}" click="search()"/>
        <mx:Spacer width="100"/>
        <nestor:Locale/>
    </mx:HBox>
    <mx:Panel title="{resourceManager.getString('resources', 'program')}" width="100%" height="100%">

        <mx:Label id="creationDate" text="{program.creationDate}"/>
        <mx:Label id="modificationDate" text="{program.modifiedDate}"/>
        <mx:Form id="formId">
            <mx:FormItem label="{resourceManager.getString('resources', 'name')}" required="true">
                <mx:TextInput id="programName" text="{program.name}"/>
            </mx:FormItem>
            <mx:FormItem direction="horizontal" label="{resourceManager.getString('resources', 'recipient')}"
                         required="true">
                <mx:ComboBox id="recipient" dataProvider="{recipients}"
                             prompt="{resourceManager.getString('resources', 'prompt')}"/>
                <mx:Button icon="@Embed('icon/addlink.gif')" click="showRecipientPicker(event)"></mx:Button>
            </mx:FormItem>
            <mx:FormItem label="Nom du chef de projet">
                <mx:TextInput id="managerName" text="{program.managerName}"/>
            </mx:FormItem>
            <mx:FormItem direction="horizontal" label="{getString('bureau')}">
                <mx:ComboBox id="bureau" dataProvider="{bureaus}"
                             prompt="{resourceManager.getString('resources', 'prompt')}"/>
                <mx:Button icon="@Embed('icon/addlink.gif')" click="showBureauPicker(event)"></mx:Button>
            </mx:FormItem>
            <mx:FormItem label="Désignation du bureau d'étude:">
                <mx:DateField id="bureauDesignationDate" selectedDate="{program.bureauDesignationDate}"/>
            </mx:FormItem>
            <mx:FormItem label="Conseil communal">
                <mx:DateField id="councilDate" selectedDate="{program.councilDate}"/>
            </mx:FormItem>
            <mx:FormItem label="Désignation du chef de projet">
                <mx:DateField id="managerDesignationDate" selectedDate="{program.managerDesignationDate}"/>
            </mx:FormItem>
            <mx:FormItem>
                <mx:Button label="Save" click="save()"/>
            </mx:FormItem>
        </mx:Form>
    </mx:Panel>


</mx:Application>